{{ extend './home/home.html' }}

{{ block 'title' }}
找回密码
{{ /block }}

{{ block 'style' }}
<style>
    body{
        background: #fff;
    }
    .box{
        width: 100%;
        height: 90vh;
        display: flex;
        justify-content: center;
    }
    .main_content{
        height: 100%;
        width: 40%;
        padding-top: 50px;
        overflow: hidden;
    }
    .about{
        font-size: 20px;
        padding-bottom: 6px;
        font-weight: normal;
    }
    .tab_bar{
        margin: 16px 0 30px -10px;
        height: 35px;
        line-height: 35px;
        background: #e1e1e1;
        color: #242424;
        overflow: hidden;
    }
    .tab_bar div{
        float: left;
    }
    .tab_bar .l{
        padding: 0 6px 0 30px;
    }
    .tab_bar .r{
        width: 19px;
        height: 35px;
        margin-right: -19px;
        position: relative;
        z-index: 2;
    }
    .code-from{
        height: 64px;
    }
    .code-from .form-control{
        width: 55%;
        float: left;
    }
    .code-from .code-btn{
        width: 40%;
        float: right;
    }
    .form-group div{
        display: block;
        width: 100%;
        height: 30px;
        line-height: 30px;
        text-align: left;
        color: #cacaca;
        float: left;
    }
    .form-group{
        width: 70%;
        margin: 0 auto 40px;
    }
    .tabs{
        margin-bottom: 30px;
    }
    .submit{
        width: 70%;
        margin: 0 auto;
        display: block;
    }
    .hide{
        display: none;
    }
</style>
{{ /block }}


{{ block 'content' }}
<div class="box">
    <div class="main_content">
        <div class="tabs">
            <div class="about">找回密码流程：</div>
            <div class="tab_bar">
                <div class="l"><i>1&nbsp;</i>输入账号信息</div>
                <div class="r">&nbsp;></div>
                <div class="l"><i>2&nbsp;</i>修改新密码</div>
                <div class="r">&nbsp;></div>
                <div class="l"><i>3&nbsp;</i>找回密码</div>
                <div class="r">&nbsp;</div>
            </div>
            <div style="clear: both;"></div>
        </div>

        <form action="" class="form1">
            <div class="form-group">
                <input type="email" class="form-control" id="exampleInputEmail1" placeholder="输入您的账号邮箱" name="email">
            </div>
            <div class="form-group code-from">
                <input type="text" class="form-control" placeholder="输入验证码" id="code" name="code">
                <button type="button" class="btn btn-success code-btn">发送验证码</button>
                <div>若没收到邮箱验证码，请检查邮箱是否填写正确</div>
            </div>
            <button type="submit" class="btn btn-info submit">提交</button>
        </form>

        <form action="" class="form2 hide">
            <div class="form-group">
                <label for="psd1">请输入新密码</label>
                <input type="password" class="form-control" id="psd1" placeholder="输入新密码" name="psd1">
            </div>

            <div class="form-group">
                <label for="psd2">再次输入新密码</label>
                <input type="password" class="form-control" id="psd2" placeholder="再次输入新密码" name="psd2">
            </div>

            <button type="submit" class="btn btn-info submit">提交</button>
        </form>

    </div>
</div>
{{ /block }}




{{ block 'script' }}
<script src="/node_modules/jquery/dist/jquery.js"></script>
<script>
    $(function () {
        let $userEmail = null

        //处理发送验证码按钮事件
        const $codeBtn = $('.code-btn')
        let $code = null
        $codeBtn.click(function () {
            const $email = $('#exampleInputEmail1')[0].value
            if (!$email) {
                return window.alert('请输入电子邮箱')
            }
            $.ajax({
                url: '/sendemail',
                dataType: 'json',
                type: 'get',
                data: {email: $email},
                success: function (data) {
                    if (data.status === 0) {
                        window.alert('验证码发送失败，该邮箱不存在')
                    } else if (data.status === -1) {
                        window.alert('验证码发送失败，服务器繁忙，请稍后重试')
                    } else if (data.status === 1) {
                        window.alert('验证码发送成功，请尽快填写')
                        $code = data.code

                        $codeBtn.attr('disabled', 'disabled')
                        let totalTimer = setTimeout(() => {
                            $codeBtn.removeAttr('disabled')
                            $codeBtn.html('发送验证码')
                        }, 60000)
                        let countDown = 60
                        let eachTimer = setInterval(() => {
                            countDown--
                            if (countDown > 0) {
                                $codeBtn.html(countDown + '秒后可再次发送')
                            } else {
                                clearInterval(eachTimer)
                                clearTimeout(totalTimer)
                            }
                        }, 1000)
                    }
                }
            })
        })

        //处理找回密码账号验证
        const $submit1 = $('.form1 .submit')
        const $form1 = $('.form1')
        const $form2 = $('.form2')
        $submit1.click(function (e) {
            e.preventDefault()
            const $email = $('#exampleInputEmail1')[0].value
            const user_code = $('#code')[0].value
            const $formdata1 = 'email=' + $email + '&severCode=' + $code + '&code=' +user_code
            $.ajax({
                url: '/account',
                type: 'post',
                data: $formdata1,
                dataType: 'json',
                success: function (data) {
                    if(data.status === 2) {
                        window.alert('该邮箱尚未注册')
                    }
                    else if(data.status === 0) {
                        window.alert('验证码填写错误，请重新填写')
                    }
                    else if(data.status === 500) {
                        window.alert('服务器繁忙，请稍后重试')
                    }
                    else if(data.status === 1) {
                        window.alert('验证成功')
                        $userEmail = data.userInfo.email
                        $form1.addClass('hide')
                        $form2.removeClass('hide')
                    }
                }

            })
        })

        //修改新密码
        const $submit2 = $('.form2 .submit')
        $submit2.click(function (e) {
            e.preventDefault()
            const psd1 = $('#psd1')[0].value
            const psd2 = $('#psd2')[0].value
            //检查用户输入密码是否一致
            if(psd1 !== psd2) {
                window.alert('两次输入密码不一致，请仔细检查')
            }
            else {
                const $formdata2 = 'psd=' + psd1 + '&email=' + $userEmail
                $.ajax({
                    url: '/forget',
                    type: 'post',
                    dataType: 'json',
                    data: $formdata2,
                    success: function (data) {
                        if(data.status === 500) {
                            return window.alert('服务器繁忙，请稍后重试')
                        }
                        else if(data.status === 0) {
                            return window.alert('无法查询到该账号邮箱')
                        }
                        else if(data.status === 1) {
                            window.alert('密码修改成功')
                            window.location.href = '/login'
                        }
                    }
                })
            }
        })
    })
</script>
{{ /block }}